# Privacy Review – 20250903235537_create_common_functions.sql
**Datum:** 2025-09-03  
**Änderungstyp:** DB-Migration (Supabase, EU/Frankfurt)

## Zweck & Scope
Erstellt zentrale Hilfsfunktion `set_user_id_from_auth()` für Owner-RLS. Keine neuen personenbezogenen Datenfelder; nur Durchsetzung von `user_id := auth.uid()`.

## Datenkategorien
Art. 9 (Gesundheitsbezug) möglich in `cycle_data` (bereits bestehend). **Diese Migration fügt keine neuen PII-Spalten hinzu.**

## Rechtsgrundlage
Einwilligung (Consent) – bereits implementiertes Consent-Gate bleibt unverändert.

## Technische Schutzmaßnahmen
- RLS: owner-based (`user_id = auth.uid()`), alle CRUD-Policies vorhanden.
- Trigger: `BEFORE INSERT` setzt/erzwingt `user_id := auth.uid()` (Basis-Variante).
- Unique-Index pro User (`ux_cycle_data_user`) verhindert Mehrfacheinträge.

## Risiko & Mitigation
- Risiko Fehlkonfiguration Client → **Mitigation:** Trigger + RLS.
- Risiko Datenzugriff fremder User → **Mitigation:** RLS-Beweis getestet (A/B-JWT).

## Migrations-Auswirkung
Keine Datenmigration; nur Funktions-Definition. Kein Downtime-Risiko.

## Rollback
- Wichtig: Erst abhängige Trigger entfernen, dann die Funktion anfassen (sonst Dependency-Errors).
  - Beispiel (cycle_data): `DROP TRIGGER IF EXISTS set_cycle_data_user_id ON public.cycle_data;`
  - Weitere mögliche Abhängigkeiten prüfen (z.B. `set_profiles_user_id` auf `public.profiles`).
- Danach: `DROP FUNCTION public.set_user_id_from_auth();` oder `CREATE OR REPLACE FUNCTION ...` (je nach Zielzustand).
- Vor Re-Create/Replace verifizieren, dass keine Dependencies mehr existieren (z.B. via `pg_trigger`/`pg_depend`).

## Entscheidung
✅ Freigabe – keine zusätzlichen Datenschutzrisiken.
