# Privacy Review – daily_plan (Migration 20250907122819)

**Datum:** 2026-01-24 (retroaktives Review; Dateiname folgt Migrationstimestamp)

**Zweck:** Tagesplan (Stimmung, Energie, Symptome, Aktivitäten) zur Personalisierung von Training/Ernährung/Regeneration.

**Datentypen:** Datum, Stimmungslabel, Energie (1–10), Symptome (JSON), Aktivitäten (JSON), Ernährung (JSON), Schlafstunden, Trainings-/Bewegungsminuten, Wasseraufnahme, Notizen (Text). Keine medizinischen Diagnosen; dennoch potenziell Gesundheitsdaten durch Selbstangaben (z. B. Symptome).

**Datenkategorien:** Potenziell besondere Kategorien (Art. 9) aufgrund Gesundheits-/Symptomdaten (Selbstangaben).

**Rechtsgrundlage:** Einwilligung (Art. 6 Abs. 1 a, Art. 9 Abs. 2 a DSGVO). Widerruf jederzeit in der App.

**Sicherheit:** Row-Level-Security (owner-based, `user_id = auth.uid()`); Trigger setzt `user_id` automatisch. Indizes für Performance.

**Datenminimierung:** Nur erforderliche Felder; optionale Felder sind freiwillig.

**Speicherfrist:** Bis Widerruf/Löschung; Nutzer kann Daten exportieren/löschen (DSAR).

**Weitergabe:** Keine an Dritte ohne Einwilligung; nur EU-Region (Supabase EU).

**Änderungen in Migration:** neue Tabelle `daily_plan`; 4 Policies (SELECT/INSERT/UPDATE/DELETE); Trigger `set_user_id_from_auth()`; `updated_at`-Trigger; Indizes.

## Risiko & Mitigation
- Risiko Client-Fehlkonfiguration/Manipulation (z. B. `user_id` gesetzt) → **Mitigation:** Trigger `set_user_id_from_auth()` erzwingt `user_id := auth.uid()`; RLS `WITH CHECK (user_id = auth.uid())`.
- Risiko unautorisierter Zugriff (fremde User/anon) → **Mitigation:** Owner-RLS (`USING user_id = auth.uid()`); ohne gültige Auth ist `auth.uid()` null und liefert keine Treffer/keine Inserts.

## Migrations-Auswirkung
- Neu: Tabelle `public.daily_plan` inkl. Trigger und Indizes.
- Keine bestehende Datenmigration; additive Änderung → geringes Downtime-Risiko.

## Rollback
- **Vorab empfohlen:** Backup oder Soft-Delete, z. B. `CREATE TABLE public.daily_plan_backup AS TABLE public.daily_plan;` (oder DB-Dump) und/oder `deleted_at`-Flag einführen + später prune.
- Rücknahme durch `DROP TABLE public.daily_plan;` (Achtung: irreversibler Datenverlust für alle `daily_plan`-Einträge).

## Entscheidung
✅ Freigabe – Owner-RLS + Trigger setzen/erzwingen `user_id`; keine neuen Empfänger/Transfers; Zweck bleibt im Consent-Umfang.
