name: Supabase DB Apply (dev)
on:
  workflow_dispatch:
jobs:
  apply-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # PAT for supabase link fallback (Only used when DB_URL_DEV is empty).
    env:
      SUPABASE_DB_URL_DEV: ${{ secrets.SUPABASE_DB_URL_DEV }}
      SUPABASE_PROJECT_REF_DEV: ${{ secrets.SUPABASE_PROJECT_REF_DEV }}
      SUPABASE_DB_PASSWORD_DEV: ${{ secrets.SUPABASE_DB_PASSWORD_DEV }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: 2.54.11
      - name: Apply via DB URL (preferred)
        if: ${{ env.SUPABASE_DB_URL_DEV != '' }}
        env:
          SUPABASE_DB_URL: ${{ env.SUPABASE_DB_URL_DEV }}
        run: supabase db push --db-url "$SUPABASE_DB_URL"
      - name: Apply via project link (fallback)
        if: ${{ env.SUPABASE_DB_URL_DEV == '' && env.SUPABASE_PROJECT_REF_DEV != '' && env.SUPABASE_DB_PASSWORD_DEV != '' && env.SUPABASE_ACCESS_TOKEN != '' }}
        env:
          SUPABASE_PROJECT_REF: ${{ env.SUPABASE_PROJECT_REF_DEV }}
          SUPABASE_DB_PASSWORD: ${{ env.SUPABASE_DB_PASSWORD_DEV }}
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"
          supabase db push --linked

      - name: Fail (missing Supabase credentials)
        if: ${{ env.SUPABASE_DB_URL_DEV == '' && (env.SUPABASE_PROJECT_REF_DEV == '' || env.SUPABASE_DB_PASSWORD_DEV == '' || env.SUPABASE_ACCESS_TOKEN == '') }}
        run: |
          echo "Supabase DB apply skipped: Provide SUPABASE_DB_URL_DEV or fallback secrets (PROJECT_REF/DB_PASSWORD)."
          echo "- has project ref:  ${{ env.SUPABASE_PROJECT_REF_DEV != '' }}"
          echo "- has db password:  ${{ env.SUPABASE_DB_PASSWORD_DEV != '' }}"
          echo "- has access token: ${{ env.SUPABASE_ACCESS_TOKEN != '' }}"
          exit 1
