name: rotate-keys-automation
on:
  workflow_dispatch:
    inputs:
      rotation_reason:
        description: "Reason for rotation (ticket/incident)"
        required: true
        type: string
      dry_run:
        description: "Set to false to apply the rotation"
        required: true
        default: "true"
        type: string
      old_key_id:
        description: "Identifier for the current key (e.g., sha256 fingerprint) before rotation"
        required: true
        type: string
jobs:
  rotate-consent-key:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      CONSENT_HASH_PEPPER_NEXT: ${{ secrets.CONSENT_HASH_PEPPER_NEXT }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: 2.54.11
      - name: Validate rotation inputs
        run: |
          echo "rotation_reason: ${{ inputs.rotation_reason }}"
          echo "dry_run: ${{ inputs.dry_run }}"
          if [ -z "${SUPABASE_PROJECT_REF}" ] || [ -z "${SUPABASE_DB_PASSWORD}" ] || [ -z "${SUPABASE_ACCESS_TOKEN}" ]; then
            echo "Missing Supabase credentials (SUPABASE_PROJECT_REF / SUPABASE_DB_PASSWORD / SUPABASE_ACCESS_TOKEN)."
            exit 1
          fi
          if [ -z "${CONSENT_HASH_PEPPER_NEXT}" ]; then
            echo "Missing CONSENT_HASH_PEPPER_NEXT secret."
            exit 1
          fi
          if [ -z "${{ inputs.old_key_id }}" ]; then
            echo "Missing old_key_id input."
            exit 1
          fi
      - name: Link Supabase project
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: supabase link --project-ref "${SUPABASE_PROJECT_REF}"
      - name: Rotate consent hash key (apply)
        if: ${{ inputs.dry_run == 'false' }}
        run: supabase secrets set CONSENT_HASH_PEPPER="${CONSENT_HASH_PEPPER_NEXT}"
      - name: Verify rotated consent hash key
        if: ${{ inputs.dry_run == 'false' }}
        id: verify-rotation
        run: |
          if ! supabase secrets list | grep -q '^CONSENT_HASH_PEPPER$'; then
            echo "CONSENT_HASH_PEPPER not found after rotation."
            exit 1
          fi
          new_key_id="$(printf '%s' "${CONSENT_HASH_PEPPER_NEXT}" | openssl dgst -sha256 | awk '{print $NF}')"
          if [ "${#new_key_id}" -ne 64 ]; then
            echo "Invalid CONSENT_HASH_PEPPER_NEXT fingerprint length."
            exit 1
          fi
          echo "new_key_id=${new_key_id}" >> "$GITHUB_OUTPUT"
      - name: Write rotation audit log
        if: ${{ inputs.dry_run == 'false' }}
        run: |
          timestamp="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          actor="${{ github.actor }}"
          reason="${{ inputs.rotation_reason }}"
          old_key_id="${{ inputs.old_key_id }}"
          new_key_id="${{ steps.verify-rotation.outputs.new_key_id }}"
          cat > rotation-audit.json <<EOF
          {
            "timestamp": "${timestamp}",
            "actor": "${actor}",
            "reason": "${reason}",
            "old_key_id": "${old_key_id}",
            "new_key_id": "${new_key_id}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}"
          }
          EOF
      - name: Upload rotation audit log
        if: ${{ inputs.dry_run == 'false' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: rotation-audit-log
          path: rotation-audit.json
      - name: Dry run (no changes applied)
        if: ${{ inputs.dry_run != 'false' }}
        run: echo "Dry run only. Set dry_run=false to apply rotation."
