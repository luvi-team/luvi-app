name: rotate-keys-automation
on:
  workflow_dispatch:
    inputs:
      rotation_reason:
        description: "Reason for rotation (ticket/incident)"
        required: true
        type: string
      dry_run:
        description: "Set to false to apply the rotation"
        required: true
        default: "true"
        type: string
jobs:
  rotate-consent-key:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      CONSENT_HASH_PEPPER_NEXT: ${{ secrets.CONSENT_HASH_PEPPER_NEXT }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: 2.54.11
      - name: Validate rotation inputs
        run: |
          echo "rotation_reason: ${{ inputs.rotation_reason }}"
          echo "dry_run: ${{ inputs.dry_run }}"
          if [ -z "${SUPABASE_PROJECT_REF}" ] || [ -z "${SUPABASE_DB_PASSWORD}" ] || [ -z "${SUPABASE_ACCESS_TOKEN}" ]; then
            echo "Missing Supabase credentials (SUPABASE_PROJECT_REF / SUPABASE_DB_PASSWORD / SUPABASE_ACCESS_TOKEN)."
            exit 1
          fi
          if [ -z "${CONSENT_HASH_PEPPER_NEXT}" ]; then
            echo "Missing CONSENT_HASH_PEPPER_NEXT secret."
            exit 1
          fi
      - name: Link Supabase project
        run: supabase link --project-ref "${SUPABASE_PROJECT_REF}" --password "${SUPABASE_DB_PASSWORD}"
      - name: Rotate consent hash key (apply)
        if: ${{ inputs.dry_run == 'false' }}
        run: supabase secrets set CONSENT_HASH_PEPPER="${CONSENT_HASH_PEPPER_NEXT}"
      - name: Dry run (no changes applied)
        if: ${{ inputs.dry_run != 'false' }}
        run: echo "Dry run only. Set dry_run=false to apply rotation."
