name: Flutter CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  analyze-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: '3.27.0'
      - run: flutter pub get
      - run: flutter analyze
      - run: dart run dcm analyze || true
      - run: flutter test --no-pub

  privacy-gate:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            migrations:
              - 'supabase/migrations/**'
            privacy_docs:
              - 'docs/privacy/reviews/**'

      - name: Enforce privacy review when migrations changed
        if: ${{ steps.changes.outputs.migrations == 'true' && steps.changes.outputs.privacy_docs != 'true' }}
        run: |
          echo "::error::Supabase-Migrationen geändert – bitte docs/privacy/reviews/<id>.md aktualisieren."
          exit 1

  pr-change-report:
    if: ${{ always() && github.event_name == 'pull_request' }}
    needs: [analyze-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            migrations:
              - 'supabase/migrations/**'
            privacy_docs:
              - 'docs/privacy/reviews/**'

      - name: Prepare environment
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          echo "TEST_STATUS=${{ needs.analyze-test.result }}" >> $GITHUB_ENV
          echo "ADR_IDS=$(echo "${{ github.event.pull_request.body }}" | grep -Eo '\\b(0001|0002|0003)\\b' | sort -u | paste -sd, -)" >> $GITHUB_ENV

      - name: Compute changes (paths and numstat)
        run: |
          mkdir -p context/changes
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > /tmp/changed_paths.txt || true
          git diff --numstat "$BASE_SHA" "$HEAD_SHA" > /tmp/numstat.txt || true

      - name: Generate PR change report (Markdown)
        run: |
          REPORT="context/changes/pr-${PR_NUMBER}.md"
          {
            echo "# PR ${PR_NUMBER} – Change Report"
            echo ""
            echo "## Zusammenfassung"
            echo "- Teststatus (analyze/test): ${TEST_STATUS}"
            echo "- Supabase-Migrationen geändert: ${{ steps.changes.outputs.migrations }}"
            echo "- Privacy-Docs im PR: ${{ steps.changes.outputs.privacy_docs }}"
            echo "- ADR-IDs aus PR-Body: ${ADR_IDS:-keine}"
            echo ""
            echo "## Geänderte Pfade"
            if [ -s /tmp/changed_paths.txt ]; then
              echo "$(sed 's/^/- /' /tmp/changed_paths.txt)"
            else
              echo "- (keine)"
            fi
            echo ""
            echo "## Zeilenänderungen pro Datei (+/−)"
            echo "| Datei | + Zeilen | - Zeilen |"
            echo "|---|---:|---:|"
            if [ -s /tmp/numstat.txt ]; then
              awk '{print "| "$3" | "$1" | "$2" |"}' /tmp/numstat.txt
            fi
            echo ""
            echo "> Hinweis: DSGVO-safe – keine Diff-Inhalte gespeichert."
          } > "$REPORT"
          echo "Erstellt: $REPORT"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-change-report-${{ env.PR_NUMBER }}
          path: context/changes/pr-${{ env.PR_NUMBER }}.md
