name: Flutter CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'
jobs:
  analyze-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2
        with:
          channel: stable
          flutter-version: '3.35.4'
          cache: true
      - name: Log Flutter version
        run: flutter --version
      - run: flutter pub get
      - name: Generate localizations (gen-l10n)
        run: flutter gen-l10n
      - name: Enforce l10n generated files up-to-date
        run: |
          git diff --exit-code lib/l10n || {
            echo "::error::lib/l10n not up-to-date. Run 'flutter gen-l10n' locally and commit generated files.";
            git --no-pager diff -- lib/l10n || true;
            exit 1;
          }
      - run: flutter analyze
      - run: flutter pub run dart_code_metrics:metrics analyze lib --disable-sunset-warning || true
      - run: flutter test --no-pub

  log-consent-contract:
    name: Edge Contract / log_consent
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_ANON_KEY != '' }}
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_ANON_KEY != '' }}
        name: Setup Deno
        uses: denoland/setup-deno@11b63cf76cfcafb4e43f97b6cad24d8e8438f62d # v1.5.2
        with:
          deno-version: v1.44.4

      - if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_ANON_KEY != '' }}
        name: Export optional overrides for log_consent tests
        env:
          LOG_CONSENT_FUNCTION_URL_SECRET: ${{ secrets.LOG_CONSENT_FUNCTION_URL }}
          LOG_CONSENT_TEST_EMAIL_SECRET: ${{ secrets.LOG_CONSENT_TEST_EMAIL }}
          LOG_CONSENT_TEST_PASSWORD_SECRET: ${{ secrets.LOG_CONSENT_TEST_PASSWORD }}
        run: |
          if [ -n "$LOG_CONSENT_FUNCTION_URL_SECRET" ]; then
            echo "LOG_CONSENT_FUNCTION_URL=$LOG_CONSENT_FUNCTION_URL_SECRET" >> "$GITHUB_ENV"
          fi
          if [ -n "$LOG_CONSENT_TEST_EMAIL_SECRET" ]; then
            echo "LOG_CONSENT_TEST_EMAIL=$LOG_CONSENT_TEST_EMAIL_SECRET" >> "$GITHUB_ENV"
          fi
          if [ -n "$LOG_CONSENT_TEST_PASSWORD_SECRET" ]; then
            echo "LOG_CONSENT_TEST_PASSWORD=$LOG_CONSENT_TEST_PASSWORD_SECRET" >> "$GITHUB_ENV"
          fi

      - if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_ANON_KEY != '' }}
        name: Run log_consent contract tests
        run: deno test --allow-env --allow-net --allow-read supabase/tests/log_consent.test.ts

      - if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_ANON_KEY != '' }}
        name: Run log_consent SSOT scope test
        run: deno test --allow-read supabase/functions/log_consent/consent_scopes_ssot.test.ts

  privacy-gate:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Block service_role usage in client code (RLS safety)
        run: |
          if grep -R -nI -E '\bservice_role\b' lib/ >/dev/null 2>&1; then
            echo "::error::Gefährlicher Fund: 'service_role' im Client-Code (lib/). RLS würde umgangen. Bitte entfernen (ADR-0002)."
            echo "Treffer:" && grep -R -nI -E '\bservice_role\b' lib/ || true
            exit 1
          else
            echo "Kein 'service_role' im Client (lib/) gefunden."
          fi
      - name: Block placeholder privacy fallback (PR)
        run: |
          FILE="docs/privacy/privacy.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::$FILE fehlt. Für DSGVO-Compliance ist eine finale Datenschutzerklärung erforderlich (oder extern verlinkt via PRIVACY_URL)."
            exit 1
          fi
          if grep -inE '\b(Bitte ersetzen Sie diesen Text|PLACEHOLDER)\b' "$FILE" >/dev/null 2>&1; then
            echo "::error::$FILE enthält Platzhaltertext. Bitte finale DSGVO-konforme Datenschutzerklärung einpflegen und Legal-Freigabe dokumentieren."
            sed -n '1,80p' "$FILE" || true
            exit 1
          else
            echo "Privacy fallback-Datei enthält keinen offensichtlichen Platzhalter."
          fi

      - name: Warn if terms fallback looks like a draft (non-blocking)
        run: |
          TERMS="docs/privacy/terms.md"
          if [ -f "$TERMS" ] && grep -nE '\bDRAFT\b|PENDING LEGAL|NICHT PRODUKTIV AUSLIEFERN' "$TERMS" >/dev/null 2>&1; then
            echo "::notice::$TERMS scheint ein Entwurf zu sein (DRAFT/PENDING LEGAL). Für Produktion finalisieren und freigeben lassen."
          fi
      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        with:
          filters: |
            migrations:
              - 'supabase/migrations/**'
            privacy_docs:
              - 'docs/privacy/reviews/**'
            ai_layer:
              - 'lib/**/ai/**'
              - 'lib/services/ai_gateway/**'
              - 'services/ai_gateway/**'
              - 'features/**/ai/**'

      - name: Enforce privacy review when migrations changed
        if: ${{ steps.changes.outputs.migrations == 'true' && steps.changes.outputs.privacy_docs != 'true' }}
        run: |
          echo "::error::Supabase-Migrationen geändert – bitte docs/privacy/reviews/<id>.md aktualisieren."
          exit 1

      - name: Enforce privacy review when AI layer changed
        if: ${{ steps.changes.outputs.ai_layer == 'true' && steps.changes.outputs.privacy_docs != 'true' }}
        run: |
          echo "::error::AI-Layer geändert – bitte docs/privacy/reviews/<id>.md aktualisieren (Opt-in/Datennutzung/Logging prüfen)."
          exit 1

  pr-change-report:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
    needs: [analyze-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        with:
          filters: |
            migrations:
              - 'supabase/migrations/**'
            privacy_docs:
              - 'docs/privacy/reviews/**'
            memory_file:
              - 'context/debug/memory.md'

      - name: Prepare environment
        run: |
          echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          echo "TEST_STATUS=${{ needs.analyze-test.result }}" >> $GITHUB_ENV
          read -r -d '' BODY <<'EOF' || true
          ${{ github.event.pull_request.body }}
          EOF

          ADR_IDS=$(printf '%s' "$BODY" | grep -Eo '\\b(0001|0002|0003)\\b' | sort -u | paste -sd, -)
          echo "ADR_IDS=$ADR_IDS" >> "$GITHUB_ENV"

      - name: Compute changes (paths and numstat)
        run: |
          mkdir -p context/changes
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > /tmp/changed_paths.txt || true
          git diff --numstat "$BASE_SHA" "$HEAD_SHA" > /tmp/numstat.txt || true

      - name: Generate PR change report (Markdown)
        run: |
          REPORT="context/changes/pr-${PR_NUMBER}.md"
          {
            echo "# PR ${PR_NUMBER} – Change Report"
            echo ""
            echo "## Zusammenfassung"
            echo "- Teststatus (analyze/test): ${TEST_STATUS}"
            echo "- Supabase-Migrationen geändert: ${{ steps.changes.outputs.migrations }}"
            echo "- Privacy-Docs im PR: ${{ steps.changes.outputs.privacy_docs }}"
            echo "- Project-Memory aktualisiert (context/debug/memory.md): ${{ steps.changes.outputs.memory_file }}"
            echo "- ADR-IDs aus PR-Body: ${ADR_IDS:-keine}"
            echo ""
            echo "## Geänderte Pfade"
            if [ -s /tmp/changed_paths.txt ]; then
              echo "$(sed 's/^/- /' /tmp/changed_paths.txt)"
            else
              echo "- (keine)"
            fi
            echo ""
            echo "## Zeilenänderungen pro Datei (+/−)"
            echo "| Datei | + Zeilen | - Zeilen |"
            echo "|---|---:|---:|"
            if [ -s /tmp/numstat.txt ]; then
              awk '{print "| "$3" | "$1" | "$2" |"}' /tmp/numstat.txt
            fi
            echo ""
            echo "> Hinweis: DSGVO-safe – keine Diff-Inhalte gespeichert."
          } > "$REPORT"
          echo "Erstellt: $REPORT"

      - name: Add PR notice for missing memory update (non-blocking)
        if: ${{ steps.changes.outputs.memory_file != 'true' }}
        run: |
          echo "::notice::Kein Update von context/debug/memory.md im PR gefunden – bitte 1–3 Zeilen (Fokus/Fix/Checkpoint) ergänzen."

      - name: Upload report artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: pr-change-report-${{ env.PR_NUMBER }}
          path: context/changes/pr-${{ env.PR_NUMBER }}.md

  agents-drift:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Install dependencies (ripgrep)
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
      - name: Run agents drift check
        run: |
          bash context/agents/_drift_check.sh || true
          echo "## Agents Drift Report" >> "$GITHUB_STEP_SUMMARY"
          echo "Generated on: $(date -u)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,200p' context/agents/_drift_report.md >> "$GITHUB_STEP_SUMMARY" || true
      - name: Upload drift report artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: agents-drift-report-${{ github.run_id }}
          path: context/agents/_drift_report.md
