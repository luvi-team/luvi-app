# Check Governance Documentation
# Validates CLAUDE.md and AGENTS.md have proper structure
# MVP version: Pure Bash, zero dependencies, ~10s runtime
name: Check Governance Docs

on:
  pull_request:
    paths:
      - 'CLAUDE.md'
      - 'AGENTS.md'
      - 'context/agents/**'

jobs:
  check:
    name: Validate Governance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check CLAUDE.md frontmatter exists
        run: |
          if ! head -1 CLAUDE.md | grep -q "^---$"; then
            echo "::error::CLAUDE.md must start with YAML frontmatter (---)"
            exit 1
          fi
          echo "Frontmatter exists"

      - name: Check acceptance version reference
        run: |
          VERSION=$(grep -oP 'acceptance_version:\s*"\K[0-9]+\.[0-9]+' CLAUDE.md | head -1)
          if [ -z "$VERSION" ]; then
            echo "::error::No acceptance_version found in CLAUDE.md frontmatter"
            exit 1
          fi
          FILE="context/agents/_acceptance_v${VERSION}.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::Referenced file not found: $FILE"
            exit 1
          fi
          echo "Acceptance v${VERSION} exists"

      - name: Check MUST rules present
        run: |
          COUNT=$(grep -c 'id: "MUST-' CLAUDE.md || echo "0")
          if [ "$COUNT" -lt 5 ]; then
            echo "::warning::Less than 5 MUST rules found ($COUNT)"
          else
            echo "Found $COUNT MUST rules"
          fi
